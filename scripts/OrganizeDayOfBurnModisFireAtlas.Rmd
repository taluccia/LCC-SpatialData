---
title: "OrganizeDayOfBurnModisFireAtlas"
author: "Anna Talucci"
date: "2025-04-29"
output: html_document
---

```{r clear environment, include=FALSE}
rm(list=ls())
```

# Overview

Combine all point with DoB attribute for FWI extract.

```{r}
library(sf)
library(tidyverse)

#--------------------------------------
# Helper: read & merge MODIS + matching Fire Atlas files
#--------------------------------------
process_dataset <- function(modis_file, fa_dir, fa_years, dataset_type) {
  # dataset_type is "LC" or "LCC"
  
  # Build full paths for Fire Atlas files
  fa_files <- file.path(
    fa_dir,
    sprintf("%s_fireAtlas_dob_%d.shp", dataset_type, fa_years)
  )
  
  # Check existence
  missing_files <- fa_files[!file.exists(fa_files)]
  if (length(missing_files) > 0) {
    warning("Missing Fire Atlas files: ", paste(basename(missing_files), collapse = ", "))
  }
  
  # Read and combine Fire Atlas
  fa <- map(fa_files[file.exists(fa_files)], ~ st_read(.x, quiet = TRUE)) %>%
    bind_rows()
  
  # Read MODIS
  modis <- st_read(modis_file, quiet = TRUE) %>%
    mutate(fireYr = as.numeric(fireYr))
  
  # Prepare Fire Atlas dataframe without geometry
  fa_df <- fa %>%
    st_drop_geometry() %>%
    mutate(ted_date = as.Date(paste(ted_year, ted_month, ted_day, sep = "-"))) %>% 
    select(ID, ted_doy, ted_date)
  
  # Merge and fill dob/date
  combined <- modis %>%
    full_join(fa_df, by = c("ID")) %>%
    mutate(
      dob = coalesce(dob, ted_doy),
      ted_date = as.character(ted_date),
      date = coalesce(date, ted_date)
    ) 
  
  # Keep one row per ID with dob
  dob_df <- combined %>%
    group_by(ID) %>%
    slice(1) %>%
    ungroup() %>%
    drop_na(dob)
  
  return(dob_df)
}

#--------------------------------------
# Paths & settings
#--------------------------------------
fa_dir     <- "../outputs/2025-08-11_fireatlas_dob"
fa_years   <- c(2013, 2015, 2017, 2018, 2019, 2020, 2021, 2022)

lc_file    <- "../outputs/LCC_cleaned/points/shapefiles/2025-08-11_lc_pts_dob.shp"
lcc_file   <- "../outputs/LCC_cleaned/points/shapefiles/2025-08-11_lcc_pts_dob.shp"

#--------------------------------------
# Process LC and LCC separately
#--------------------------------------
lc_dob  <- process_dataset(lc_file,  fa_dir, fa_years, "LC")
lcc_dob <- process_dataset(lcc_file, fa_dir, fa_years, "LCC")

#--------------------------------------
# Write outputs
#--------------------------------------
st_write(lc_dob,  "../outputs/LCC_cleaned/points/shapefiles/2025-08-11_LC_dob.shp",  delete_layer = TRUE)
st_write(lcc_dob, "../outputs/LCC_cleaned/points/shapefiles/2025-08-11_LCC_dob.shp", delete_layer = TRUE)

```
```{r}
lc = st_read("../outputs/LCC_cleaned/points/shapefiles/2025-08-11_LC_dob.shp", "2025-08-11_LC_dob")
```

```{r}
lcc = st_read("../outputs/LCC_cleaned/points/shapefiles/2025-08-11_LCC_dob.shp", "2025-08-11_LCC_dob")
```

```{r}
lc
lcc
```

```{r}
lc %>% filter(is.na(dob))
lcc %>% filter(is.na(dob))
```

```{r}
cat(paste0(sprintf("'%s'", sort(unique(lc$date))), collapse = ", "))
```


```{r}
cat(paste0(sprintf("'%s'", sort(unique(lcc$date))), collapse = ", "))
```